<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Deck</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Login Page -->
    <div id="login-page" class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-8 space-y-8 text-center">
        <h1 class="text-4xl font-bold text-gray-800">Welcome to Command Deck</h1>
        <p class="mt-2 text-lg text-gray-600">Sign in to access your personal roster.</p>
        
        <form id="auth-form" class="space-y-4">
            <input type="email" id="email-input" placeholder="Email" required class="w-full p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="password-input" placeholder="Password" required class="w-full p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <button type="button" id="register-btn" class="flex-grow px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                    Register
                </button>
                <button type="button" id="sign-in-btn" class="flex-grow px-4 py-2 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition-colors shadow-lg">
                    Sign In
                </button>
            </div>
        </form>
        <p id="auth-message" class="text-sm text-red-500 mt-4"></p>
    </div>

    <!-- Command Deck Page (Initially Hidden) -->
    <div id="roster-app-page" class="hidden bg-white rounded-2xl shadow-xl w-full max-w-4xl p-8 space-y-8">
        <header class="text-center">
            <h1 id="command-deck-title" class="text-4xl font-bold text-gray-800">Command Deck</h1>
            <p class="mt-2 text-lg text-gray-600">Organize your units and track point limits.</p>
        </header>
        
        <div class="flex justify-between items-center">
            <div class="text-sm text-gray-600">Your User ID: <span id="user-id" class="font-mono text-gray-800"></span></div>
            <button id="sign-out-btn" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-xl shadow-lg hover:bg-gray-600 transition-colors">
                Sign Out
            </button>
        </div>

        <!-- Control Buttons -->
        <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="add-battleship" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                Battleship
            </button>
            <button id="add-heavy-cruiser" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                Heavy Cruiser
            </button>
            <button id="add-cruiser" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                Cruiser
            </button>
        </div>
        
        <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="add-blue-planet" class="w-full sm:w-auto px-6 py-3 bg-cyan-600 text-white font-semibold rounded-xl hover:bg-cyan-700 transition-colors shadow-lg">
                Blue Planet
            </button>
            <button id="add-red-planet" class="w-full sm:w-auto px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition-colors shadow-lg">
                Red Planet
            </button>
            <button id="add-gold-planet" class="w-full sm:w-auto px-6 py-3 bg-yellow-500 text-white font-semibold rounded-xl hover:bg-yellow-600 transition-colors shadow-lg">
                Gold Planet
            </button>
        </div>

        <!-- Add Unit Form -->
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Unit Assignment</h2>
            <form id="add-unit-form" class="space-y-4">
                <div>
                    <label for="group-select" class="block text-sm font-medium text-gray-700">Muster Point</label>
                    <select id="group-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div>
                    <label for="faction-select" class="block text-sm font-medium text-gray-700">Select a Faction</label>
                    <select id="faction-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div id="chapter-select-container" class="hidden">
                    <label for="chapter-select" class="block text-sm font-medium text-gray-700">Select a Chapter</label>
                    <select id="chapter-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div>
                    <label for="detachment-select" class="block text-sm font-medium text-gray-700">Select a Detachment</label>
                    <select id="detachment-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div>
                    <label for="unit-select" class="block text-sm font-medium text-gray-700">Select a Unit</label>
                    <select id="unit-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <button type="submit" class="w-full px-4 py-2 bg-emerald-600 text-white font-semibold rounded-xl hover:bg-emerald-700 transition-colors shadow-lg">
                    Add Unit
                </button>
            </form>
        </div>

        <!-- Roster Display Area -->
        <div id="rosters-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Roster cards will be populated by JavaScript -->
        </div>

        <!-- Message Box for Alerts -->
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
                <p id="message-text" class="text-gray-800 text-lg font-medium"></p>
                <button id="close-message" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors">OK</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Your Firebase project configuration ---
const firebaseConfig = {
  apiKey: "AIzaSyCt_hsh6MCo_0sNWFKtAlsM-oSGVRGDPF8",
  authDomain: "conquest-command-deck.firebaseapp.com",
  projectId: "conquest-command-deck",
  storageBucket: "conquest-command-deck.firebasestorage.app",
  messagingSenderId: "993959061285",
  appId: "1:993959061285:web:438296814ad21edc0b1ccc",
  measurementId: "G-87NN5SXHXB"
};
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DOM Element References ---
        const loginPage = document.getElementById('login-page');
        const rosterAppPage = document.getElementById('roster-app-page');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const registerBtn = document.getElementById('register-btn');
        const signInBtn = document.getElementById('sign-in-btn');
        const authMessage = document.getElementById('auth-message');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userIdSpan = document.getElementById('user-id');
        
        const addBattleshipBtn = document.getElementById('add-battleship');
        const addHeavyCruiserBtn = document.getElementById('add-heavy-cruiser');
        const addCruiserBtn = document.getElementById('add-cruiser');
        const addBluePlanetBtn = document.getElementById('add-blue-planet');
        const addRedPlanetBtn = document.getElementById('add-red-planet');
        const addGoldPlanetBtn = document.getElementById('add-gold-planet');
        const rostersContainer = document.getElementById('rosters-container');
        const addUnitForm = document.getElementById('add-unit-form');
        const groupSelect = document.getElementById('group-select');
        const factionSelect = document.getElementById('faction-select');
        const chapterSelectContainer = document.getElementById('chapter-select-container');
        const chapterSelect = document.getElementById('chapter-select');
        const detachmentSelect = document.getElementById('detachment-select');
        const unitSelect = document.getElementById('unit-select');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageBtn = document.getElementById('close-message');
        
        // --- Core Data Model ---
        let groups = [];
        let nextGroupId = 0;
        let currentPlayerId = null;

        // Re-structured units data with factions and chapters.
        const factionsData = {
            "Adeptus Astartes": {
                "general": [
                    { name: "Adrax Agatone", cost: 85 },
                    { name: "Aggressor Squad (3 models)", cost: 100 },
                    { name: "Aggressor Squad (6 models)", cost: 220 },
                    { name: "Ancient", cost: 50 },
                    { name: "Ancient in Terminator Armour", cost: 75 },
                    { name: "Apothecary", cost: 50 },
                    { name: "Apothecary Biologis", cost: 70 },
                    { name: "Assault Intercessor Squad (5 models)", cost: 75 },
                    { name: "Assault Intercessor Squad (10 models)", cost: 150 },
                    { name: "Assault Intercessors with Jump Packs (5 models)", cost: 90 },
                    { name: "Assault Intercessors with Jump Packs (10 models)", cost: 160 },
                    { name: "Ballistus Dreadnought", cost: 140 },
                    { name: "Bladeguard Ancient", cost: 45 },
                    { name: "Bladeguard Veteran Squad (3 models)", cost: 80 },
                    { name: "Bladeguard Veteran Squad (6 models)", cost: 160 },
                    { name: "Brutalis Dreadnought", cost: 160 },
                    { name: "Captain", cost: 80 },
                    { name: "Captain in Gravis Armour", cost: 80 },
                    { name: "Captain in Phobos Armour", cost: 70 },
                    { name: "Captain in Terminator Armour", cost: 95 },
                    { name: "Captain Sicarius", cost: 85 },
                    { name: "Captain with Jump Pack", cost: 75 },
                    { name: "Centurion Assault Squad (3 models)", cost: 150 },
                    { name: "Centurion Assault Squad (6 models)", cost: 300 },
                    { name: "Centurion Devastator Squad (3 models)", cost: 165 },
                    { name: "Centurion Devastator Squad (6 models)", cost: 330 },
                    { name: "Chaplain", cost: 60 },
                    { name: "Chaplain in Terminator Armour", cost: 75 },
                    { name: "Chaplain on Bike", cost: 75 },
                    { name: "Chaplain with Jump Pack", cost: 75 },
                    { name: "Chief Librarian Tigurius", cost: 75 },
                    { name: "Company Heroes (4 models)", cost: 105 },
                    { name: "Darnath Lysander", cost: 100 },
                    { name: "Desolation Squad (5 models)", cost: 200 },
                    { name: "Devastator Squad (5 models)", cost: 120 },
                    { name: "Devastator Squad (10 models)", cost: 200 },
                    { name: "Dreadnought", cost: 135 },
                    { name: "Drop Pod", cost: 70 },
                    { name: "Eliminator Squad (3 models)", cost: 85 },
                    { name: "Eradicator Squad (3 models)", cost: 100 },
                    { name: "Eradicator Squad (6 models)", cost: 200 },
                    { name: "Firestrike Servo-turrets (1 model)", cost: 75 },
                    { name: "Firestrike Servo-turrets (2 models)", cost: 150 },
                    { name: "Gladiator Lancer", cost: 160 },
                    { name: "Gladiator Reaper", cost: 160 },
                    { name: "Gladiator Valiant", cost: 160 },
                    { name: "Hammerfall Bunker", cost: 175 },
                    { name: "Heavy Intercessor Squad (5 models)", cost: 100 },
                    { name: "Heavy Intercessor Squad (10 models)", cost: 200 },
                    { name: "Hellblaster Squad (5 models)", cost: 110 },
                    { name: "Hellblaster Squad (10 models)", cost: 220 },
                    { name: "Impulsor", cost: 80 },
                    { name: "Inceptor Squad (3 models)", cost: 120 },
                    { name: "Inceptor Squad (6 models)", cost: 240 },
                    { name: "Incursor Squad (5 models)", cost: 80 },
                    { name: "Incursor Squad (10 models)", cost: 160 },
                    { name: "Infernus Squad (5 models)", cost: 90 },
                    { name: "Infernus Squad (10 models)", cost: 180 },
                    { name: "Infiltrator Squad (5 models)", cost: 100 },
                    { name: "Infiltrator Squad (10 models)", cost: 200 },
                    { name: "Intercessor Squad (5 models)", cost: 80 },
                    { name: "Intercessor Squad (10 models)", cost: 160 },
                    { name: "Invader ATV", cost: 60 },
                    { name: "Invictor Tactical Warsuit", cost: 125 },
                    { name: "Iron Father Feirros", cost: 95 },
                    { name: "Judiciar", cost: 70 },
                    { name: "Kayvaan Shrike", cost: 100 },
                    { name: "Korâ€™sarro Khan", cost: 70 },
                    { name: "Land Raider", cost: 240 },
                    { name: "Land Raider Crusader", cost: 220 },
                    { name: "Land Raider Redeemer", cost: 285 },
                    { name: "Librarian", cost: 65 },
                    { name: "Librarian in Phobos Armour", cost: 70 },
                    { name: "Librarian in Terminator Armour", cost: 75 },
                    { name: "Lieutenant", cost: 65 },
                    { name: "Lieutenant in Phobos Armour", cost: 55 },
                    { name: "Lieutenant in Reiver Armour", cost: 55 },
                    { name: "Lieutenant with Combi-weapon", cost: 70 },
                    { name: "Lieutenant Titus", cost: 70 },
                    { name: "Marneus Calgar (3 models)", cost: 200 },
                    { name: "Outrider Squad (3 models)", cost: 80 },
                    { name: "Outrider Squad (6 models)", cost: 160 },
                    { name: "Invader ATV", cost: 60 },
                    { name: "Pedro Kantor", cost: 90 },
                    { name: "Predator Annihilator", cost: 135 },
                    { name: "Predator Destructor", cost: 140 },
                    { name: "Razorback", cost: 95 },
                    { name: "Redemptor Dreadnought", cost: 210 },
                    { name: "Reiver Squad (5 models)", cost: 80 },
                    { name: "Reiver Squad (10 models)", cost: 160 },
                    { name: "Repulsor", cost: 180 },
                    { name: "Repulsor Executioner", cost: 220 },
                    { name: "Rhino", cost: 75 },
                    { name: "Roboute Guilliman", cost: 320 },
                    { name: "Scout Squad (5 models)", cost: 70 },
                    { name: "Scout Squad (10 models)", cost: 140 },
                    { name: "Sternguard Veteran Squad (5 models)", cost: 100 },
                    { name: "Sternguard Veteran Squad (10 models)", cost: 200 },
                    { name: "Storm Speeder Hailstrike", cost: 115 },
                    { name: "Storm Speeder Hammerstrike", cost: 125 },
                    { name: "Storm Speeder Thunderstrike", cost: 150 },
                    { name: "Stormhawk Interceptor", cost: 155 },
                    { name: "Stormraven Gunship", cost: 280 },
                    { name: "Stormtalon Gunship", cost: 165 },
                    { name: "Suppressor Squad (3 models)", cost: 75 },
                    { name: "Tactical Squad (10 models)", cost: 140 },
                    { name: "Techmarine", cost: 55 },
                    { name: "Terminator Assault Squad (5 models)", cost: 180 },
                    { name: "Terminator Assault Squad (10 models)", cost: 360 },
                    { name: "Terminator Squad (5 models)", cost: 170 },
                    { name: "Terminator Squad (10 models)", cost: 340 },
                    { name: "Tor Garadon", cost: 90 },
                    { name: "Uriel Ventris", cost: 95 },
                    { name: "Vanguard Veteran Squad with Jump Packs (5 models)", cost: 95 },
                    { name: "Vanguard Veteran Squad with Jump Packs (10 models)", cost: 190 },
                    { name: "Vindicator", cost: 185 },
                    { name: "Vulkan Heâ€™stan", cost: 100 },
                    { name: "Whirlwind", cost: 190 },
                    { name: "Astraeus", cost: 525 },
                    { name: "Thunderhawk Gunship", cost: 840 }
                ],
                "Black Templars": [
                    { name: "Castellan", cost: 60 },
                    { name: "Chaplain Grimaldus (4 models)", cost: 110 },
                    { name: "Crusade Ancient", cost: 65 },
                    { name: "Crusader Squad (1 Sword Brother, 5 Initiates and 4 Neophytes)", cost: 150 },
                    { name: "Crusader Squad (1 Sword Brother, 11 Initiates and 8 Neophytes)", cost: 310 },
                    { name: "Emperorâ€™s Champion", cost: 90 },
                    { name: "Execrator", cost: 70 },
                    { name: "Gladiator Lancer", cost: 160 },
                    { name: "Gladiator Reaper", cost: 160 },
                    { name: "Gladiator Valiant", cost: 160 },
                    { name: "High Marshal Helbrecht", cost: 120 },
                    { name: "Impulsor", cost: 85 },
                    { name: "Land Raider Crusader", cost: 220 },
                    { name: "Marshal", cost: 80 },
                    { name: "Sternguard Veteran Squad (5 models)", cost: 85 },
                    { name: "Sternguard Veteran Squad (10 models)", cost: 170 },
                    { name: "Sword Brethren (4 models)", cost: 105 },
                    { name: "Sword Brethren (5 models)", cost: 130 },
                    { name: "Sword Brethren (9 models)", cost: 235 },
                    { name: "Sword Brethren (10 models)", cost: 260 },
                    { name: "Terminator Squad (5 models)", cost: 175 },
                    { name: "Terminator Squad (10 models)", cost: 330 },
                    { name: "Repulsor", cost: 180 },
                    { name: "Repulsor Executioner", cost: 220 }
                ],
                "Blood Angels": [
                    { name: "Astorath", cost: 95 },
                    { name: "Baal Predator", cost: 125 },
                    { name: "Blood Angels Captain", cost: 80 },
                    { name: "Chief Librarian Mephiston", cost: 120 },
                    { name: "Commander Dante", cost: 120 },
                    { name: "Death Company Captain", cost: 70 },
                    { name: "Death Company Captain with Jump Pack", cost: 75 },
                    { name: "Death Company Dreadnought", cost: 160 },
                    { name: "Death Company Marines (5 models)", cost: 85 },
                    { name: "Death Company Marines (10 models)", cost: 160 },
                    { name: "Death Company Marines with Bolt Rifles (5 models)", cost: 85 },
                    { name: "Death Company Marines with Bolt Rifles (10 models)", cost: 160 },
                    { name: "Death Company Marines with Jump Packs (5 models)", cost: 120 },
                    { name: "Death Company Marines with Jump Packs (10 models)", cost: 230 },
                    { name: "Lemartes", cost: 100 },
                    { name: "Sanguinary Guard (3 models)", cost: 110 },
                    { name: "Sanguinary Guard (6 models)", cost: 240 },
                    { name: "Sanguinary Priest", cost: 75 },
                    { name: "The Sanguinor", cost: 140 }
                ],
                "Dark Angels": [],
                "Deathwatch": [],
                "Imperial Fists": [],
                "Iron Hands": [],
                "Raven Guard": [],
                "Salamanders": [],
                "Space Wolves": [],
                "UltraMarines": [],
                "White Scars": []
            },
            "Adeptus Custodes": [],
            "Adeptus Mechanicus": [],
            "Adeptus Sororitas": [],
            "Adeptus Titanicus": [],
            "Aeldari": [],
            "Astra Militarum": [],
            "Chaos Knights": [],
            "Death Guard": [],
            "Demons": [],
            "Drukhari": [],
            "Emperors Children": [],
            "Genestealer Cults": [],
            "Grey Knights": [],
            "Heretic Astartes": [
                { name: "Abaddon the Despoiler (1 model)", cost: 280 },
                { name: "Accursed Cultists (8 models)", cost: 90 },
                { name: "Accursed Cultists (16 models)", cost: 195 },
                { name: "Chaos Bikers (3 models)", cost: 70 },
                { name: "Chaos Bikers (6 models)", cost: 130 },
                { name: "Chaos Land Raider (1 model)", cost: 240 },
                { name: "Chaos Lord (1 model)", cost: 90 },
                { name: "Chaos Lord in Terminator Armour (1 model)", cost: 95 },
                { name: "Chaos Lord with Jump Pack (1 model)", cost: 80 },
                { name: "Chaos Predator Annihilator (1 model)", cost: 135 },
                { name: "Chaos Predator Destructor (1 model)", cost: 140 },
                { name: "Chaos Rhino (1 model)", cost: 75 },
                { name: "Chaos Spawn (2 models)", cost: 70 },
                { name: "Chaos Terminator Squad (5 models)", cost: 180 },
                { name: "Chaos Terminator Squad (10 models)", cost: 360 },
                { name: "Chaos Vindicator (1 model)", cost: 185 },
                { name: "Chosen (5 models)", cost: 125 },
                { name: "Chosen (10 models)", cost: 250 },
                { name: "Cultist Firebrand (1 model)", cost: 45 },
                { name: "Cultist Mob (10 models)", cost: 50 },
                { name: "Cultist Mob (20 models)", cost: 100 },
                { name: "Cypher (1 model)", cost: 90 },
                { name: "Dark Apostle (3 models)", cost: 65 },
                { name: "Dark Commune (5 models)", cost: 80 },
                { name: "Defiler (1 model)", cost: 190 },
                { name: "Fabius Bile (2 models)", cost: 85 },
                { name: "Fellgor Beastmen (10 models)", cost: 70 },
                { name: "Forgefiend (1 model)", cost: 180 },
                { name: "Haarken Worldclaimer (1 model)", cost: 90 },
                { name: "Havocs (5 models)", cost: 125 },
                { name: "Helbrute (1 model)", cost: 130 },
                { name: "Heldrake (1 model)", cost: 205 },
                { name: "Heretic Astartes Daemon Prince (1 model)", cost: 165 },
                { name: "Heretic Astartes Daemon Prince with Wings (1 model)", cost: 180 },
                { name: "Huron Blackheart (1 model)", cost: 80 },
                { name: "Khorne Lord of Skulls (1 model)", cost: 450 },
                { name: "Legionaries (5 models)", cost: 90 },
                { name: "Legionaries (10 models)", cost: 170 },
                { name: "Lord Discordant on Helstalker (1 model)", cost: 160 },
                { name: "Master of Executions (1 model)", cost: 80 },
                { name: "Master of Possession (1 model)", cost: 60 },
                { name: "Maulerfiend (1 model)", cost: 130 },
                { name: "Nemesis Claw (5 models)", cost: 110 },
                { name: "Nemesis Claw (10 models)", cost: 190 },
                { name: "Noctilith Crown (1 model)", cost: 125 },
                { name: "Obliterators (2 models)", cost: 160 },
                { name: "Possessed (5 models)", cost: 120 },
                { name: "Possessed (10 models)", cost: 240 },
                { name: "Raptors (5 models)", cost: 90 },
                { name: "Raptors (10 models)", cost: 170 },
                { name: "Sorcerer (1 model)", cost: 60 },
                { name: "Sorcerer in Terminator Armour (1 model)", cost: 80 },
                { name: "Traitor Enforcer (2 models)", cost: 55 },
                { name: "Traitor Guardsmen Squad (10 models)", cost: 70 },
                { name: "Vashtorr the Arkifane (1 model)", cost: 175 },
                { name: "Venomcrawler (1 model)", cost: 120 },
                { name: "Warp Talons (5 models)", cost: 125 },
                { name: "Warp Talons (10 models)", cost: 270 },
                { name: "Warpsmith (1 model)", cost: 70 }
            ],
            "Imperial Agents": [],
            "Leagues of Votann": [],
            "Necrons": [
                { name: "Annihilation Barge", cost: 105 },
                { name: "Câ€™tan Shard of the Deceiver", cost: 265 },
                { name: "Câ€™tan Shard of the Nightbringer", cost: 305 },
                { name: "Câ€™tan Shard of the Void Dragon", cost: 300 },
                { name: "Canoptek Doomstalker", cost: 140 },
                { name: "Canoptek Reanimator", cost: 75 },
                { name: "Canoptek Scarab Swarms (3 models)", cost: 40 },
                { name: "Canoptek Scarab Swarms (6 models)", cost: 80 },
                { name: "Canoptek Spyders (1 model)", cost: 75 },
                { name: "Canoptek Spyders (2 models)", cost: 150 },
                { name: "Canoptek Wraiths (3 models)", cost: 110 },
                { name: "Canoptek Wraiths (6 models)", cost: 220 },
                { name: "Catacomb Command Barge", cost: 120 },
                { name: "Chronomancer", cost: 65 },
                { name: "Convergence of Dominion (1 model)", cost: 60 },
                { name: "Convergence of Dominion (2 models)", cost: 120 },
                { name: "Convergence of Dominion (3 models)", cost: 180 },
                { name: "Cryptothralls (2 models)", cost: 60 },
                { name: "Deathmarks (5 models)", cost: 60 },
                { name: "Deathmarks (10 models)", cost: 120 },
                { name: "Doom Scythe", cost: 230 },
                { name: "Doomsday Ark", cost: 200 },
                { name: "Flayed Ones (5 models)", cost: 60 },
                { name: "Flayed Ones (10 models)", cost: 120 },
                { name: "Ghost Ark", cost: 115 },
                { name: "Hexmark Destroyer", cost: 75 },
                { name: "Illuminor Szeras", cost: 165 },
                { name: "Immortals (5 models)", cost: 70 },
                { name: "Immortals (10 models)", cost: 150 },
                { name: "Imotekh the Stormlord", cost: 100 },
                { name: "Lokhust Destroyers (1 model)", cost: 40 },
                { name: "Lokhust Destroyers (2 models)", cost: 60 },
                { name: "Lokhust Destroyers (3 models)", cost: 90 },
                { name: "Lokhust Destroyers (6 models)", cost: 180 },
                { name: "Lokhust Heavy Destroyers (1 model)", cost: 55 },
                { name: "Lokhust Heavy Destroyers (2 models)", cost: 110 },
                { name: "Lokhust Heavy Destroyers (3 models)", cost: 165 },
                { name: "Lokhust Lord", cost: 80 },
                { name: "Lychguard (5 models)", cost: 85 },
                { name: "Lychguard (10 models)", cost: 170 },
                { name: "Monolith", cost: 400 },
                { name: "Necron Warriors (10 models)", cost: 90 },
                { name: "Necron Warriors (20 models)", cost: 200 },
                { name: "Night Scythe", cost: 145 },
                { name: "Obelisk", cost: 300 },
                { name: "Ophydian Destroyers (3 models)", cost: 80 },
                { name: "Ophydian Destroyers (6 models)", cost: 160 },
                { name: "Orikan the Diviner", cost: 80 },
                { name: "Overlord", cost: 85 },
                { name: "Overlord with Translocation Shroud", cost: 85 },
                { name: "Plasmancer", cost: 55 },
                { name: "Psychomancer", cost: 55 },
                { name: "Royal Warden", cost: 50 },
                { name: "Skorpekh Destroyers (3 models)", cost: 90 },
                { name: "Skorpekh Destroyers (6 models)", cost: 180 },
                { name: "Skorpekh Lord", cost: 90 },
                { name: "Technomancer", cost: 80 },
                { name: "Tesseract Vault", cost: 425 },
                { name: "The Silent King (3 models)", cost: 420 },
                { name: "Tomb Blades (3 models)", cost: 75 },
                { name: "Tomb Blades (6 models)", cost: 150 },
                { name: "Transcendent Câ€™tan", cost: 295 },
                { name: "Trazyn the Infinite", cost: 75 },
                { name: "Triarch Praetorians (5 models)", cost: 100 },
                { name: "Triarch Praetorians (10 models)", cost: 200 },
                { name: "Triarch Stalker", cost: 110 },
                { name: "Seraptek Heavy Construct", cost: 540 }
            ],
            "Orks": [],
            "Tau Empire": [],
            "Thousand Sons": [],
            "Titanicus Traitoris": [],
            "Tyranids": [],
            "World Eaters": [
                { name: "Angron", cost: 385 },
                { name: "Chaos Land Raider", cost: 240 },
                { name: "Chaos Predator Annihilator", cost: 145 },
                { name: "Chaos Predator Destructor", cost: 145 },
                { name: "Chaos Rhino", cost: 85 },
                { name: "Chaos Spawn (2 models)", cost: 80 },
                { name: "Chaos Terminators (5 models)", cost: 185 },
                { name: "Chaos Terminators (10 models)", cost: 370 },
                { name: "Daemon Prince of Khorne", cost: 200 },
                { name: "Daemon Prince of Khorne with Wings", cost: 180 },
                { name: "Defiler", cost: 180 },
                { name: "Eightbound (3 models)", cost: 150 },
                { name: "Eightbound (6 models)", cost: 300 },
                { name: "Exalted Eightbound (3 models)", cost: 160 },
                    { name: "Exalted Eightbound (6 models)", cost: 320 },
                { name: "Forgefiend", cost: 150 },
                { name: "Goremongers (8 models)", cost: 85 },
                { name: "Helbrute", cost: 120 },
                { name: "Heldrake", cost: 200 },
                { name: "Jakhals (10 models)", cost: 65 },
                { name: "Jakhals (20 models)", cost: 140 },
                { name: "KhÃ¢rn the Betrayer", cost: 85 },
                { name: "Khorne Berzerkers (10 models)", cost: 180 },
                { name: "Khorne Berzerkers (20 models)", cost: 360 },
                { name: "Khorne Lord of Skulls", cost: 505 },
                { name: "Lord Invocatus", cost: 110 },
                { name: "Lord on Juggernaut", cost: 90 },
                { name: "Master of Executions", cost: 60 },
                { name: "Maulerfiend", cost: 150 },
                { name: "Slaughterbound", cost: 85 },
                { name: "Bloodcrushers (3 models)", cost: 110 },
                { name: "Bloodcrushers (6 models)", cost: 220 },
                { name: "Bloodletters (10 models)", cost: 90 },
                { name: "Bloodthirster", cost: 305 },
                { name: "Flesh Hounds (5 models)", cost: 75 },
                { name: "Flesh Hounds (10 models)", cost: 150 },
                { name: "Skarbrand", cost: 305 }
            ],
        };
        
        const detachmentsData = {
            "General": [],
            "Adeptus Astartes": ["Gladius Task Force", "Anvil Siege Force", "Firestorm Assault Force", "Ironstorm Spearhead", "Stormlance Task Force", "Vanguard Spearhead", "1st Company Task Force", "Sons of Sanguinius", "Black Spear Task Force", "Champions of Russ", "Lion's Blade Task Force", "Wrathful Procession", "Champions of Fenris", "Angelic Inheritors", "Librarius Conclave"],
            "Adeptus Custodes": ["Auric Champions", "Lions of the Emperor", "Null Maiden Vigil", "Shield Host", "Solar Spearhead", "Talons of the Emperor"],
            "Adeptus Mechanicus": ["Rad-Zone Corps", "Skitarii Hunter Cohort", "Data-Psalm Conclave", "Explorator Maniple"],
            "Adeptus Sororitas": ["Hallowed Martyrs", "Penitent Host", "Bringers of Flame", "Army of Faith", "Champions of Faith"],
            "Adeptus Titanicus": [],
            "Aeldari": ["Aspect Host", "Seer Council", "Windrider Host", "Guardian Battlehost", "Spirit Conclave", "Ghosts of the Webway", "Devoted of Ynnead"],
            "Astra Militarum": ["Combined Arms", "Bridgehead Strike", "Siege Regiment", "Recon Element"],
            "Chaos Knights": ["Traitoris Lance", "Infernal Lance", "Lords of Dread", "Houndpack Lance"],
            "Death Guard": ["Virulent Vectorium", "Champions of Contagion", "Death Lord's Chosen", "Mortarion's Hammer", "Shamblerot Vectorium", "Tallyband Summoners", "Flyblown Host", "The Shambling Horde"],
            "Demons": ["Legion of Excess", "Plague Legion", "Blood Legion", "Scintillating Legion"],
            "Drukhari": ["Realspace Raiders"],
            "Emperors Children": ["Coterie of the Conceited", "Slaanesh's Chosen", "Mercurial Host", "Rapid Evisceration", "Peerless Bladesmen"],
            "Genestealer Cults": ["Brood Brothers Auxilia", "Xenocreed Congregation", "Ascension Day"],
            "Grey Knights": ["Banishers"],
            "Heretic Astartes": [
                "Pactbound Zealots",
                "Veterans of the Long War",
                "Fellhammer Siege-host",
                "Dread Talons",
                "Deceptors",
                "Soulforged Warpack",
                "Renegade Raiders",
                "Creations of Bile",
                "Chaos Cult",
                "Cabal of Chaos"
            ],
            "Imperial Agents": ["Imperialis Fleet", "Ordo Hereticus Purgation Squad", "Ordo Malleus Daemon Hunters", "Ordo Xenos Alien Hunters", "Veiled Blade Elimination Force"],
            "Leagues of Votann": ["Hostile Acquisition", "Fortify Takeover", "Brandfast Oathband"],
            "Necrons": [
                "Awakened Dynasty",
                "Annihilation Legion",
                "Canoptek Court",
                "Obeisance Phalanx",
                "Hypercrypt Legion"
            ],
            "Orks": ["Taktikal Brigade", "War Horde", "Green Tide", "Bully Boyz", "Dread Mob", "Da Big Hunt", "Kult of Speed", "More Dakka"],
            "Tau Empire": ["Kauyon", "Mont'ka", "Retaliation Cadre", "Kroot Hunting Pack"],
            "Thousand Sons": ["Hexwarp Thrallband"],
            "Titanicus Traitoris": [],
            "Tyranids": [],
            "World Eaters": [
                "Disciples of the Red Angel",
                "Berzerker Warband",
                "Tallyband Summoners"
            ],
        };

        // --- Core Application Logic ---
        let groups = [];
        let nextGroupId = 0;
        let currentPlayerId = null;

        function showMessage(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        function clearMessage() {
            messageText.textContent = '';
            messageBox.classList.add('hidden');
        }

        async function saveGroups(playerId) {
            if (!playerId) return;
            const playerDocRef = doc(db, `rosters`, playerId);
            try {
                await setDoc(playerDocRef, { groups: groups });
            } catch (error) {
                console.error("Error saving groups:", error);
                showMessage("Failed to save roster. Please check your connection.");
            }
        }

        function loadGroups(playerId) {
            if (!playerId) return;
            const playerDocRef = doc(db, `rosters`, playerId);
            onSnapshot(playerDocRef, (doc) => {
                if (doc.exists()) {
                    groups = doc.data().groups;
                } else {
                    groups = [];
                }
                nextGroupId = groups.length > 0 ? Math.max(...groups.map(g => g.id)) + 1 : 0;
                renderUI();
            }, (error) => {
                console.error("Error listening to group changes:", error);
            });
        }
        
        function addGroup(name, pointLimit) {
            const newGroup = {
                id: nextGroupId++,
                name: name,
                pointLimit: pointLimit,
                pointsUsed: 0,
                units: [],
                fallenUnits: [],
                detachment: '',
            };
            groups.push(newGroup);
            saveGroups(currentPlayerId);
            renderUI();
        }

        function editGroupName(groupId, newName) {
            const group = groups.find(g => g.id === parseInt(groupId));
            if (group) {
                group.name = newName;
                saveGroups(currentPlayerId);
                renderUI();
            }
        }

        function addUnit(groupId, unitName, unitCost) {
            const group = groups.find(g => g.id === parseInt(groupId));
            if (!group) {
                showMessage("Error: Group not found.");
                return;
            }

            if (group.pointsUsed + unitCost > group.pointLimit) {
                showMessage(`Cannot add unit. Adding ${unitCost} points would exceed the group's limit of ${group.pointLimit}.`);
                return;
            }

            const newUnit = {
                name: unitName,
                cost: unitCost
            };
            group.units.push(newUnit);
            group.pointsUsed += unitCost;
            
            saveGroups(currentPlayerId);
            renderUI();
        }

        function deleteUnit(groupId, unitIndex) {
            const group = groups.find(g => g.id === parseInt(groupId));
            if (!group || !group.units[unitIndex]) {
                showMessage("Error: Unit or group not found.");
                return;
            }

            const unitCost = group.units[unitIndex].cost;
            group.units.splice(unitIndex, 1);
            group.pointsUsed -= unitCost;
            saveGroups(currentPlayerId);
            renderUI();
        }

        function moveUnitToFallen(groupId, unitIndex) {
            const group = groups.find(g => g.id === parseInt(groupId));
            if (!group || !group.units[unitIndex]) {
                showMessage("Error: Unit or group not found.");
                return;
            }

            const fallenUnit = group.units.splice(unitIndex, 1)[0];
            group.fallenUnits.push(fallenUnit);
            group.pointsUsed -= fallenUnit.cost;
            saveGroups(currentPlayerId);
            renderUI();
        }

        function deleteFallenUnit(groupId, unitIndex) {
            const group = groups.find(g => g.id === parseInt(groupId));
            if (!group || !group.fallenUnits[unitIndex]) {
                showMessage("Error: Fallen unit or group not found.");
                return;
            }
            group.fallenUnits.splice(unitIndex, 1);
            saveGroups(currentPlayerId);
            renderUI();
        }

        function deleteGroup(groupId) {
            const groupIndex = groups.findIndex(g => g.id === parseInt(groupId));
            if (groupIndex !== -1) {
                groups.splice(groupIndex, 1);
                saveGroups(currentPlayerId);
                renderUI();
            }
        }

        function populateFactionSelect() {
            factionSelect.innerHTML = '<option value="" disabled selected>Select a faction...</option>';
            const factions = Object.keys(factionsData).sort();
            factions.forEach(faction => {
                const option = document.createElement('option');
                option.value = faction;
                option.textContent = faction;
                factionSelect.appendChild(option);
            });
        }

        function populateChapterSelect() {
            chapterSelect.innerHTML = '<option value="" disabled selected>Select a chapter...</option>';
            const chapters = Object.keys(factionsData["Adeptus Astartes"]).filter(c => c !== "general").sort();
            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                chapterSelect.appendChild(option);
            });
        }

        function populateDetachmentSelect(factionName) {
            detachmentSelect.innerHTML = '<option value="" disabled selected>Select a detachment...</option>';
            const detachments = detachmentsData[factionName] || detachmentsData["General"];
            
            detachments.forEach(detachment => {
                const option = document.createElement('option');
                option.value = detachment;
                option.textContent = detachment;
                detachmentSelect.appendChild(option);
            });
        }
        
        function populateUnitSelect(factionName, chapterName) {
            unitSelect.innerHTML = '<option value="" disabled selected>Select a unit...</option>';
            
            let units = [];
            if (factionName === "Adeptus Astartes") {
                if (chapterName && factionsData[factionName][chapterName]) {
                    units = factionsData[factionName][chapterName].concat(factionsData[factionName]["general"] || []);
                } else {
                    units = factionsData[factionName]["general"] || [];
                }
            } else if (factionsData[factionName] && Array.isArray(factionsData[factionName])) {
                units = factionsData[factionName];
            }

            if (units.length > 0) {
                units.forEach((unit) => {
                    const option = document.createElement('option');
                    option.dataset.cost = unit.cost;
                    option.textContent = `${unit.name} (${unit.cost} pts)`;
                    unitSelect.appendChild(option);
                });
            }
        }

        function renderUI() {
            const selectedGroupId = groupSelect.value;
            const selectedFaction = factionSelect.value;
            const selectedChapter = chapterSelect.value;
            
            rostersContainer.innerHTML = '';
            groupSelect.innerHTML = '<option value="" disabled selected>Select Ship\\Planet...</option>';

            if (groups.length === 0) {
                rostersContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">Click a button above to add a group.</p>';
            }

            groups.forEach(group => {
                const groupCard = document.createElement('div');
                groupCard.className = 'bg-gray-50 rounded-xl shadow-md p-6 border border-gray-200 relative overflow-hidden';

                const percentage = (group.pointsUsed / group.pointLimit) * 100;
                const progressBarColor = percentage > 100 ? 'bg-red-500' : 'bg-green-500';
                const progressBarWidth = Math.min(percentage, 100);
                
                groupCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 inline-block align-middle" data-group-id="${group.id}">${group.name}</h3>
                            <button class="edit-name-btn ml-2 text-gray-400 hover:text-gray-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block align-middle" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                            <div class="mt-2 text-sm text-gray-700">
                                <span class="font-semibold">Detachment:</span> ${group.detachment || '<span class="text-gray-400 italic">None</span>'}
                            </div>
                        </div>
                        <span class="text-sm font-mono text-gray-500">ID: ${group.id}</span>
                    </div>
                    
                    <div class="relative w-full h-2 rounded-full bg-gray-200 mb-4">
                        <div class="absolute inset-0 h-2 rounded-full ${progressBarColor}" style="width: ${progressBarWidth}%;"></div>
                    </div>

                    <p class="text-xl font-semibold text-gray-700">Points: ${group.pointsUsed} / ${group.pointLimit}</p>

                    <div class="mt-4 space-y-2">
                        <h4 class="text-lg font-medium text-gray-600 border-b pb-2">Units:</h4>
                        <ul id="unit-list-${group.id}"></ul>
                    </div>
                    
                    <!-- The Fallen Log -->
                    <div class="mt-8 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-medium text-red-600">The Fallen ðŸ’€</h4>
                        <ul id="fallen-list-${group.id}" class="mt-2 space-y-1"></ul>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button class="delete-group-btn px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors shadow-lg" data-group-id="${group.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block align-middle" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;

                rostersContainer.appendChild(groupCard);

                const unitList = groupCard.querySelector(`#unit-list-${group.id}`);
                if (group.units.length === 0) {
                    unitList.innerHTML = '<li class="text-gray-400 italic text-sm">No units in this group.</li>';
                } else {
                    group.units.forEach((unit, index) => {
                        const unitItem = document.createElement('li');
                        unitItem.className = 'flex items-center justify-between text-gray-700 text-sm py-1 border-b border-gray-100 last:border-b-0';
                        unitItem.innerHTML = `
                            <span>${unit.name} <span class="text-xs text-gray-500">(${unit.cost} pts)</span></span>
                            <div class="flex items-center space-x-2">
                                <!-- Tombstone button for "The Fallen" -->
                                <button class="action-btn text-gray-400 hover:text-red-500 transition-colors" data-action="fall" data-group-id="${group.id}" data-unit-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 384 512" fill="currentColor">
                                        <path d="M192 0C86 0 0 86 0 192V448C0 465.7 14.33 480 32 480H64V512H96V480H288V512H320V480H352C369.7 480 384 465.7 384 448V192C384 86 298 0 192 0zM224 256C224 264.8 216.8 272 208 272H176C167.2 272 160 264.8 160 256V224C160 215.2 167.2 208 176 208H208C216.8 208 224 215.2 224 224V256zM224 352C224 360.8 216.8 368 208 368H176C167.2 368 160 360.8 160 352V320C160 311.2 167.2 304 176 304H208C216.8 304 224 311.2 224 320V352z"/>
                                    </svg>
                                </button>
                                <!-- Trashcan button for permanent deletion -->
                                <button class="action-btn text-gray-400 hover:text-red-700 transition-colors" data-action="delete" data-group-id="${group.id}" data-unit-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        `;
                        unitList.appendChild(unitItem);
                    });
                }

                const fallenList = groupCard.querySelector(`#fallen-list-${group.id}`);
                if (group.fallenUnits.length === 0) {
                    fallenList.innerHTML = '<li class="text-gray-400 italic text-sm">None have fallen yet.</li>';
                } else {
                    group.fallenUnits.forEach((unit, index) => { // Added index here
                        const fallenItem = document.createElement('li');
                        fallenItem.className = 'flex items-center justify-between text-red-400 text-sm py-1 border-b border-gray-100 last:border-b-0';
                        fallenItem.innerHTML = `
                            <span>${unit.name} (${unit.cost} pts)</span>
                            <button class="delete-fallen-btn text-gray-400 hover:text-red-700 transition-colors" data-group-id="${group.id}" data-unit-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        `;
                        fallenList.appendChild(fallenItem);
                    });
                }

                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = `${group.name} (ID: ${group.id})`;
                groupSelect.appendChild(option);
            });

            if (selectedGroupId && groups.some(g => g.id === parseInt(selectedGroupId))) {
                groupSelect.value = selectedGroupId;
            }
            if (selectedFaction) {
                factionSelect.value = selectedFaction;
                if (selectedFaction === "Adeptus Astartes") {
                    chapterSelectContainer.classList.remove('hidden');
                    populateChapterSelect();
                    if (selectedChapter) {
                        chapterSelect.value = selectedChapter;
                    }
                } else {
                    chapterSelectContainer.classList.add('hidden');
                }
                populateUnitSelect(selectedFaction, selectedChapter);
            }

            document.querySelectorAll('.action-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const groupId = e.currentTarget.getAttribute('data-group-id');
                    const unitIndex = e.currentTarget.getAttribute('data-unit-index');
                    const action = e.currentTarget.getAttribute('data-action');
                    
                    if (action === 'delete') {
                        deleteUnit(groupId, unitIndex);
                    } else if (action === 'fall') {
                        moveUnitToFallen(groupId, unitIndex);
                    }
                });
            });

            document.querySelectorAll('.delete-fallen-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const groupId = e.currentTarget.getAttribute('data-group-id');
                    const unitIndex = e.currentTarget.getAttribute('data-unit-index');
                    deleteFallenUnit(groupId, unitIndex);
                });
            });
            
            document.querySelectorAll('.edit-name-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const groupNameElement = e.currentTarget.previousElementSibling;
                    const groupId = groupNameElement.getAttribute('data-group-id');
                    
                    const currentName = groupNameElement.textContent;
                    
                    const inputField = document.createElement('input');
                    inputField.type = 'text';
                    inputField.value = currentName;
                    inputField.className = 'text-2xl font-bold text-gray-800 bg-gray-100 rounded-md p-1 focus:outline-none focus:ring-2 focus:ring-indigo-500';

                    const saveButton = document.createElement('button');
                    saveButton.textContent = 'Save';
                    saveButton.className = 'ml-2 px-3 py-1 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600';

                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancel';
                    cancelButton.className = 'ml-2 px-3 py-1 bg-gray-300 text-gray-800 rounded-xl hover:bg-gray-400';

                    const parentDiv = groupNameElement.parentNode;
                    parentDiv.replaceChild(inputField, groupNameElement);
                    parentDiv.replaceChild(saveButton, e.currentTarget);
                    parentDiv.appendChild(cancelButton);

                    inputField.focus();

                    saveButton.addEventListener('click', () => {
                        editGroupName(groupId, inputField.value);
                    });
                    
                    cancelButton.addEventListener('click', () => {
                        renderUI();
                    });
                });
            });

            document.querySelectorAll('.delete-group-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const groupId = e.currentTarget.getAttribute('data-group-id');
                    deleteGroup(groupId);
                });
            });
        }

        // --- Event Listeners ---
        registerBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showMessage("Please enter an email and password.");
                return;
            }
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    showMessage("Registration successful! You are now signed in.");
                    // User is automatically signed in after creation
                })
                .catch((error) => {
                    showMessage(error.message);
                });
        });

        signInBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showMessage("Please enter an email and password.");
                return;
            }
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    showMessage("Sign in successful!");
                    // User is automatically signed in
                })
                .catch((error) => {
                    showMessage(error.message);
                });
        });

        signOutBtn.addEventListener('click', () => {
            signOut(auth)
                .then(() => {
                    groups = [];
                    currentPlayerId = null;
                    renderUI();
                })
                .catch((error) => {
                    showMessage(`Logout failed: ${error.message}`);
                });
        });

        groupSelect.addEventListener('change', () => {
            const selectedGroupId = groupSelect.value;
            const selectedGroup = groups.find(g => g.id === parseInt(selectedGroupId));
            if (selectedGroup) {
                detachmentSelect.value = selectedGroup.detachment;
            }
        });

        detachmentSelect.addEventListener('change', (e) => {
            const selectedDetachment = e.target.value;
            
            const selectedGroupId = groupSelect.value;
            if (selectedGroupId) {
                const group = groups.find(g => g.id === parseInt(selectedGroupId));
                if (group) {
                    group.detachment = selectedDetachment;
                    saveGroups(currentPlayerId);
                    renderUI();
                }
            }
        });

        factionSelect.addEventListener('change', (e) => {
            const selectedFaction = e.target.value;
            if (selectedFaction === "Adeptus Astartes") {
                chapterSelectContainer.classList.remove('hidden');
                populateChapterSelect();
            } else {
                chapterSelectContainer.classList.add('hidden');
            }
            populateDetachmentSelect(selectedFaction);
            populateUnitSelect(selectedFaction);
        });
        
        chapterSelect.addEventListener('change', (e) => {
            const selectedFaction = factionSelect.value;
            const selectedChapter = e.target.value;
            populateUnitSelect(selectedFaction, selectedChapter);
        });

        addBattleshipBtn.addEventListener('click', () => {
            addGroup('Battleship', 1500);
        });

        addHeavyCruiserBtn.addEventListener('click', () => {
            addGroup('Heavy Cruiser', 1000);
        });

        addCruiserBtn.addEventListener('click', () => {
            addGroup('Cruiser', 500);
        });
        
        addBluePlanetBtn.addEventListener('click', () => {
            addGroup('Blue Planet', 1500);
        });

        addRedPlanetBtn.addEventListener('click', () => {
            addGroup('Red Planet', 1000);
        });

        addGoldPlanetBtn.addEventListener('click', () => {
            addGroup('Gold Planet', 500);
        });

        addUnitForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const selectedGroupId = groupSelect.value;
            const selectedFaction = factionSelect.value;
            const selectedChapter = chapterSelect.value;
            const selectedUnitOption = unitSelect.options[unitSelect.selectedIndex];
            
            if (!selectedGroupId) {
                showMessage("Please select a muster point first.");
                return;
            }
            if (!selectedUnitOption || selectedUnitOption.value === "") {
                showMessage("Please select a unit to add.");
                return;
            }
            
            const group = groups.find(g => g.id === parseInt(selectedGroupId));
            const unitName = selectedUnitOption.textContent;
            const unitCost = parseInt(selectedUnitOption.dataset.cost, 10);

            if (group.pointsUsed + unitCost > group.pointLimit) {
                showMessage(`Cannot add unit. Adding ${unitCost} points would exceed the group's limit of ${group.pointLimit}.`);
                return;
            }
            
            addUnit(selectedGroupId, unitName, unitCost);

            // Reset Unit dropdown after a unit is added
            unitSelect.value = "";
            
            // Keep the last selected Faction and Chapter
            factionSelect.value = selectedFaction;
            if (selectedFaction === "Adeptus Astartes") {
                chapterSelect.value = selectedChapter;
            }
        });

        closeMessageBtn.addEventListener('click', clearMessage);
        
        // This block handles the sign-in logic
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentPlayerId = user.uid;
                userIdSpan.textContent = currentPlayerId;
                loginPage.classList.add('hidden');
                rosterAppPage.classList.remove('hidden');
                loadGroups(currentPlayerId);
            } else {
                loginPage.classList.remove('hidden');
                rosterAppPage.classList.add('hidden');
                groups = [];
                currentPlayerId = null;
                renderUI();
            }
        });
        
        populateFactionSelect();
        populateDetachmentSelect();
        populateUnitSelect();
    </script>
</body>
</html>

