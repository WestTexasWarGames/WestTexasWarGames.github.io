<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Deck</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Player Selection Page -->
    <div id="player-selection-page" class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-8 space-y-8 text-center">
        <h1 class="text-4xl font-bold text-gray-800">Select Your Command Deck</h1>
        <p class="mt-2 text-lg text-gray-600">Choose a color to begin building your roster.</p>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-8">
            <button class="player-select-btn bg-blue-600 text-white font-semibold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-colors text-xl" data-color="blue">Blue</button>
            <button class="player-select-btn bg-red-600 text-white font-semibold py-4 rounded-xl shadow-lg hover:bg-red-700 transition-colors text-xl" data-color="red">Red</button>
            <button class="player-select-btn bg-green-600 text-white font-semibold py-4 rounded-xl shadow-lg hover:bg-green-700 transition-colors text-xl" data-color="green">Green</button>
            <button class="player-select-btn bg-yellow-500 text-white font-semibold py-4 rounded-xl shadow-lg hover:bg-yellow-600 transition-colors text-xl" data-color="yellow">Yellow</button>
            <button class="player-select-btn bg-orange-500 text-white font-semibold py-4 rounded-xl shadow-lg hover:bg-orange-600 transition-colors text-xl" data-color="orange">Orange</button>
            <button class="player-select-btn bg-pink-500 text-white font-semibold py-4 rounded-xl shadow-lg hover:bg-pink-600 transition-colors text-xl" data-color="pink">Pink</button>
            <button class="player-select-btn bg-purple-600 text-white font-semibold py-4 rounded-xl shadow-lg hover:bg-purple-700 transition-colors text-xl" data-color="purple">Purple</button>
            <button class="player-select-btn bg-gray-300 text-gray-800 font-semibold py-4 rounded-xl shadow-lg hover:bg-gray-400 transition-colors text-xl" data-color="white">White</button>
        </div>
    </div>

    <!-- Command Deck Page (Initially Hidden) -->
    <div id="roster-app-page" class="hidden bg-white rounded-2xl shadow-xl w-full max-w-4xl p-8 space-y-8">
        <header class="text-center">
            <h1 id="command-deck-title" class="text-4xl font-bold text-gray-800">Command Deck</h1>
            <p class="mt-2 text-lg text-gray-600">Organize your units and track point limits.</p>
        </header>
        
        <div class="flex justify-center">
            <button id="back-to-select" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-xl shadow-lg hover:bg-gray-600 transition-colors">
                &larr; Back to Player Select
            </button>
        </div>

        <!-- Control Buttons -->
        <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="add-battleship" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                Battleship
            </button>
            <button id="add-heavy-cruiser" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                Heavy Cruiser
            </button>
            <button id="add-cruiser" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                Cruiser
            </button>
        </div>
        
        <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="add-blue-planet" class="w-full sm:w-auto px-6 py-3 bg-cyan-600 text-white font-semibold rounded-xl hover:bg-cyan-700 transition-colors shadow-lg">
                Blue Planet
            </button>
            <button id="add-red-planet" class="w-full sm:w-auto px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition-colors shadow-lg">
                Red Planet
            </button>
            <button id="add-gold-planet" class="w-full sm:w-auto px-6 py-3 bg-yellow-500 text-white font-semibold rounded-xl hover:bg-yellow-600 transition-colors shadow-lg">
                Gold Planet
            </button>
        </div>

        <!-- Add Unit Form -->
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Unit Assignment</h2>
            <form id="add-unit-form" class="space-y-4">
                <div>
                    <label for="group-select" class="block text-sm font-medium text-gray-700">Muster Point</label>
                    <select id="group-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div>
                    <label for="faction-select" class="block text-sm font-medium text-gray-700">Select a Faction</label>
                    <select id="faction-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div id="chapter-select-container" class="hidden">
                    <label for="chapter-select" class="block text-sm font-medium text-gray-700">Select a Chapter</label>
                    <select id="chapter-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div>
                    <label for="detachment-select" class="block text-sm font-medium text-gray-700">Select a Detachment</label>
                    <select id="detachment-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div>
                    <label for="unit-select" class="block text-sm font-medium text-gray-700">Select a Unit</label>
                    <select id="unit-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <button type="submit" class="w-full px-4 py-2 bg-emerald-600 text-white font-semibold rounded-xl hover:bg-emerald-700 transition-colors shadow-lg">
                    Add Unit
                </button>
            </form>
        </div>

        <!-- Roster Display Area -->
        <div id="rosters-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Roster cards will be populated by JavaScript -->
        </div>

        <!-- Message Box for Alerts -->
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
                <p id="message-text" class="text-gray-800 text-lg font-medium"></p>
                <button id="close-message" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors">OK</button>
            </div>
        </div>

    </div>

    <script>
        // JavaScript for the Unit Roster App
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Element References ---
            const playerSelectionPage = document.getElementById('player-selection-page');
            const rosterAppPage = document.getElementById('roster-app-page');
            const playerSelectBtns = document.querySelectorAll('.player-select-btn');
            const backToSelectBtn = document.getElementById('back-to-select');
            
            const addBattleshipBtn = document.getElementById('add-battleship');
            const addHeavyCruiserBtn = document.getElementById('add-heavy-cruiser');
            const addCruiserBtn = document.getElementById('add-cruiser');
            const addBluePlanetBtn = document.getElementById('add-blue-planet');
            const addRedPlanetBtn = document.getElementById('add-red-planet');
            const addGoldPlanetBtn = document.getElementById('add-gold-planet');
            const rostersContainer = document.getElementById('rosters-container');
            const addUnitForm = document.getElementById('add-unit-form');
            const groupSelect = document.getElementById('group-select');
            const factionSelect = document.getElementById('faction-select');
            const chapterSelectContainer = document.getElementById('chapter-select-container');
            const chapterSelect = document.getElementById('chapter-select');
            const detachmentSelect = document.getElementById('detachment-select');
            const unitSelect = document.getElementById('unit-select');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const closeMessageBtn = document.getElementById('close-message');
            const addUnitBtn = document.querySelector('#add-unit-form button[type="submit"]');
            const commandDeckTitle = document.getElementById('command-deck-title');

            // --- Core Data Model ---
            let groups = [];
            let nextGroupId = 0;
            
            // Re-structured units data with factions and chapters.
            const factionsData = {
                "Adeptus Astartes": {
                    "Black Templars": [],
                    "Blood Angels": [],
                    "Dark Angels": [],
                    "Deathwatch": [],
                    "Imperial Fists": [],
                    "Iron Hands": [],
                    "Raven Guard": [],
                    "Salamanders": [],
                    "Space Wolves": [],
                    "UltraMarines": [],
                    "White Scars": []
                },
                "Adeptus Custodes": [],
                "Adeptus Mechanicus": [],
                "Adeptus Sororitas": [],
                "Adeptus Titanicus": [],
                "Aeldari": [],
                "Astra Militarum": [],
                "Chaos Knights": [],
                "Death Guard": [],
                "Demons": [],
                "Drukhari": [],
                "Emperors Children": [],
                "Genestealer Cults": [],
                "Grey Knights": [],
                "Heretic Astartes": [
                    { name: "Abaddon the Despoiler (1 model)", cost: 280 },
                    { name: "Accursed Cultists (8 models)", cost: 90 },
                    { name: "Accursed Cultists (16 models)", cost: 195 },
                    { name: "Chaos Bikers (3 models)", cost: 70 },
                    { name: "Chaos Bikers (6 models)", cost: 130 },
                    { name: "Chaos Land Raider (1 model)", cost: 240 },
                    { name: "Chaos Lord (1 model)", cost: 90 },
                    { name: "Chaos Lord in Terminator Armour (1 model)", cost: 95 },
                    { name: "Chaos Lord with Jump Pack (1 model)", cost: 80 },
                    { name: "Chaos Predator Annihilator (1 model)", cost: 135 },
                    { name: "Chaos Predator Destructor (1 model)", cost: 140 },
                    { name: "Chaos Rhino (1 model)", cost: 75 },
                    { name: "Chaos Spawn (2 models)", cost: 70 },
                    { name: "Chaos Terminator Squad (5 models)", cost: 180 },
                    { name: "Chaos Terminator Squad (10 models)", cost: 360 },
                    { name: "Chaos Vindicator (1 model)", cost: 185 },
                    { name: "Chosen (5 models)", cost: 125 },
                    { name: "Chosen (10 models)", cost: 250 },
                    { name: "Cultist Firebrand (1 model)", cost: 45 },
                    { name: "Cultist Mob (10 models)", cost: 50 },
                    { name: "Cultist Mob (20 models)", cost: 100 },
                    { name: "Cypher (1 model)", cost: 90 },
                    { name: "Dark Apostle (3 models)", cost: 65 },
                    { name: "Dark Commune (5 models)", cost: 80 },
                    { name: "Defiler (1 model)", cost: 190 },
                    { name: "Fabius Bile (2 models)", cost: 85 },
                    { name: "Fellgor Beastmen (10 models)", cost: 70 },
                    { name: "Forgefiend (1 model)", cost: 180 },
                    { name: "Haarken Worldclaimer (1 model)", cost: 90 },
                    { name: "Havocs (5 models)", cost: 125 },
                    { name: "Helbrute (1 model)", cost: 130 },
                    { name: "Heldrake (1 model)", cost: 205 },
                    { name: "Heretic Astartes Daemon Prince (1 model)", cost: 165 },
                    { name: "Heretic Astartes Daemon Prince with Wings (1 model)", cost: 180 },
                    { name: "Huron Blackheart (1 model)", cost: 80 },
                    { name: "Khorne Lord of Skulls (1 model)", cost: 450 },
                    { name: "Legionaries (5 models)", cost: 90 },
                    { name: "Legionaries (10 models)", cost: 170 },
                    { name: "Lord Discordant on Helstalker (1 model)", cost: 160 },
                    { name: "Master of Executions (1 model)", cost: 80 },
                    { name: "Master of Possession (1 model)", cost: 60 },
                    { name: "Maulerfiend (1 model)", cost: 130 },
                    { name: "Nemesis Claw (5 models)", cost: 110 },
                    { name: "Nemesis Claw (10 models)", cost: 190 },
                    { name: "Noctilith Crown (1 model)", cost: 125 },
                    { name: "Obliterators (2 models)", cost: 160 },
                    { name: "Possessed (5 models)", cost: 120 },
                    { name: "Possessed (10 models)", cost: 240 },
                    { name: "Raptors (5 models)", cost: 90 },
                    { name: "Raptors (10 models)", cost: 170 },
                    { name: "Sorcerer (1 model)", cost: 60 },
                    { name: "Sorcerer in Terminator Armour (1 model)", cost: 80 },
                    { name: "Traitor Enforcer (2 models)", cost: 55 },
                    { name: "Traitor Guardsmen Squad (10 models)", cost: 70 },
                    { name: "Vashtorr the Arkifane (1 model)", cost: 175 },
                    { name: "Venomcrawler (1 model)", cost: 120 },
                    { name: "Warp Talons (5 models)", cost: 125 },
                    { name: "Warp Talons (10 models)", cost: 270 },
                    { name: "Warpsmith (1 model)", cost: 70 }
                ],
                "Imperial Agents": [],
                "Leagues of Votann": [],
                "Necrons": [],
                "Orks": [],
                "Tau Empire": [],
                "Thousand Sons": [],
                "Titanicus Traitoris": [],
                "Tyranids": [],
                "World Eaters": [],
            };
            
            const detachmentsData = {
                "General": [],
                "Adeptus Astartes": ["Gladius Task Force", "Anvil Siege Force", "Firestorm Assault Force", "Ironstorm Spearhead", "Stormlance Task Force", "Vanguard Spearhead", "1st Company Task Force", "Sons of Sanguinius", "Black Spear Task Force", "Champions of Russ", "Lion's Blade Task Force", "Wrathful Procession", "Champions of Fenris", "Angelic Inheritors", "Librarius Conclave"],
                "Adeptus Custodes": ["Auric Champions", "Lions of the Emperor", "Null Maiden Vigil", "Shield Host", "Solar Spearhead", "Talons of the Emperor"],
                "Adeptus Mechanicus": ["Rad-Zone Corps", "Skitarii Hunter Cohort", "Data-Psalm Conclave", "Explorator Maniple"],
                "Adeptus Sororitas": ["Hallowed Martyrs", "Penitent Host", "Bringers of Flame", "Army of Faith", "Champions of Faith"],
                "Adeptus Titanicus": [],
                "Aeldari": ["Aspect Host", "Seer Council", "Windrider Host", "Guardian Battlehost", "Spirit Conclave", "Ghosts of the Webway", "Devoted of Ynnead"],
                "Astra Militarum": ["Combined Arms", "Bridgehead Strike", "Siege Regiment", "Recon Element"],
                "Chaos Knights": ["Traitoris Lance", "Infernal Lance", "Lords of Dread", "Houndpack Lance"],
                "Death Guard": ["Virulent Vectorium", "Champions of Contagion", "Death Lord's Chosen", "Mortarion's Hammer", "Shamblerot Vectorium", "Tallyband Summoners", "Flyblown Host", "The Shambling Horde"],
                "Demons": ["Legion of Excess", "Plague Legion", "Blood Legion", "Scintillating Legion"],
                "Drukhari": ["Realspace Raiders"],
                "Emperors Children": ["Coterie of the Conceited", "Slaanesh's Chosen", "Mercurial Host", "Rapid Evisceration", "Peerless Bladesmen"],
                "Genestealer Cults": ["Brood Brothers Auxilia", "Xenocreed Congregation", "Ascension Day"],
                "Grey Knights": ["Banishers"],
                "Heretic Astartes": [
                    "Pactbound Zealots",
                    "Veterans of the Long War",
                    "Fellhammer Siege-host",
                    "Dread Talons",
                    "Deceptors",
                    "Soulforged Warpack",
                    "Renegade Raiders",
                    "Creations of Bile",
                    "Chaos Cult",
                    "Cabal of Chaos"
                ],
                "Imperial Agents": ["Imperialis Fleet", "Ordo Hereticus Purgation Squad", "Ordo Malleus Daemon Hunters", "Ordo Xenos Alien Hunters", "Veiled Blade Elimination Force"],
                "Leagues of Votann": ["Hostile Acquisition", "Fortify Takeover", "Brandfast Oathband"],
                "Necrons": ["Awakened Dynasty", "Annihilation Legion", "Canoptek Court", "Obeisance Phalanx", "Hypercrypt Legion"],
                "Orks": ["Taktikal Brigade", "War Horde", "Green Tide", "Bully Boyz", "Dread Mob", "Da Big Hunt", "Kult of Speed", "More Dakka"],
                "Tau Empire": ["Kauyon", "Mont'ka", "Retaliation Cadre", "Kroot Hunting Pack"],
                "Thousand Sons": ["Hexwarp Thrallband"],
                "Titanicus Traitoris": [],
                "Tyranids": [],
                "World Eaters": [],
            };

            // --- Helper Functions ---

            function showMessage(message) {
                messageText.textContent = message;
                messageBox.classList.remove('hidden');
            }

            function closeMessage() {
                messageBox.classList.add('hidden');
            }
            
            /**
             * Populates the Faction dropdown with data from the `factionsData` object.
             */
            function populateFactionSelect() {
                factionSelect.innerHTML = '<option value="" disabled selected>Select a faction...</option>';
                const factions = Object.keys(factionsData).sort();
                factions.forEach(faction => {
                    const option = document.createElement('option');
                    option.value = faction;
                    option.textContent = faction;
                    factionSelect.appendChild(option);
                });
            }

            /**
             * Populates the Chapter dropdown for Adeptus Astartes.
             */
            function populateChapterSelect() {
                chapterSelect.innerHTML = '<option value="" disabled selected>Select a chapter...</option>';
                const chapters = Object.keys(factionsData["Adeptus Astartes"]).sort();
                chapters.forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter;
                    option.textContent = chapter;
                    chapterSelect.appendChild(option);
                });
            }

            /**
             * Populates the Detachment dropdown based on the selected faction.
             * @param {string} factionName - The name of the selected faction.
             */
            function populateDetachmentSelect(factionName) {
                detachmentSelect.innerHTML = '<option value="" disabled selected>Select a detachment...</option>';
                const detachments = detachmentsData[factionName] || detachmentsData["General"];
                
                detachments.forEach(detachment => {
                    const option = document.createElement('option');
                    option.value = detachment;
                    option.textContent = detachment;
                    detachmentSelect.appendChild(option);
                });
            }
            
            /**
             * Populates the unit dropdown with units from the selected faction and chapter.
             * @param {string} factionName - The name of the selected faction.
             * @param {string} chapterName - The name of the selected chapter (optional).
             */
            function populateUnitSelect(factionName, chapterName) {
                unitSelect.innerHTML = '<option value="" disabled selected>Select a unit...</option>';
                
                let units = [];
                if (factionName === "Adeptus Astartes" && chapterName) {
                    // For Adeptus Astartes, get units from the selected chapter
                    units = factionsData[factionName][chapterName] || [];
                } else if (factionsData[factionName] && Array.isArray(factionsData[factionName])) {
                    // For other factions, get units directly from the array
                    units = factionsData[factionName];
                }

                if (units.length > 0) {
                    units.forEach((unit) => {
                        const option = document.createElement('option');
                        option.dataset.cost = unit.cost;
                        option.textContent = `${unit.name} (${unit.cost} pts)`;
                        unitSelect.appendChild(option);
                    });
                }
            }

            // --- Main Application Logic ---

            function addGroup(name, pointLimit) {
                const newGroup = {
                    id: nextGroupId++,
                    name: name,
                    pointLimit: pointLimit,
                    pointsUsed: 0,
                    units: [],
                    fallenUnits: [],
                    detachment: '',
                };
                groups.push(newGroup);
                renderUI();
            }

            function editGroupName(groupId, newName) {
                const group = groups.find(g => g.id === parseInt(groupId));
                if (group) {
                    group.name = newName;
                    renderUI();
                }
            }

            function addUnit(groupId, unitName, unitCost) {
                const group = groups.find(g => g.id === parseInt(groupId));
                if (!group) {
                    showMessage("Error: Group not found.");
                    return;
                }

                if (group.pointsUsed + unitCost > group.pointLimit) {
                    showMessage(`Cannot add unit. Adding ${unitCost} points would exceed the group's limit of ${group.pointLimit}.`);
                    return;
                }

                const newUnit = {
                    name: unitName,
                    cost: unitCost
                };
                group.units.push(newUnit);
                group.pointsUsed += unitCost;
                
                renderUI();
            }

            function deleteUnit(groupId, unitIndex) {
                const group = groups.find(g => g.id === parseInt(groupId));
                if (!group || !group.units[unitIndex]) {
                    showMessage("Error: Unit or group not found.");
                    return;
                }

                const unitCost = group.units[unitIndex].cost;
                group.units.splice(unitIndex, 1);
                group.pointsUsed -= unitCost;
                renderUI();
            }

            function moveUnitToFallen(groupId, unitIndex) {
                const group = groups.find(g => g.id === parseInt(groupId));
                if (!group || !group.units[unitIndex]) {
                    showMessage("Error: Unit or group not found.");
                    return;
                }

                const fallenUnit = group.units.splice(unitIndex, 1)[0];
                group.fallenUnits.push(fallenUnit);
                group.pointsUsed -= fallenUnit.cost;
                renderUI();
            }

            function renderUI() {
                const selectedGroupId = groupSelect.value;
                const selectedFaction = factionSelect.value;
                const selectedChapter = chapterSelect.value;
                
                rostersContainer.innerHTML = '';
                groupSelect.innerHTML = '<option value="" disabled selected>Select Ship\\Planet...</option>';

                if (groups.length === 0) {
                    rostersContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">Click a button above to add a group.</p>';
                }

                groups.forEach(group => {
                    const groupCard = document.createElement('div');
                    groupCard.className = 'bg-gray-50 rounded-xl shadow-md p-6 border border-gray-200 relative overflow-hidden';

                    const percentage = (group.pointsUsed / group.pointLimit) * 100;
                    const progressBarColor = percentage > 100 ? 'bg-red-500' : 'bg-green-500';
                    const progressBarWidth = Math.min(percentage, 100);
                    
                    groupCard.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800 inline-block align-middle" data-group-id="${group.id}">${group.name}</h3>
                                <button class="edit-name-btn ml-2 text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block align-middle" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </button>
                                <div class="mt-2 text-sm text-gray-700">
                                    <span class="font-semibold">Detachment:</span> ${group.detachment || '<span class="text-gray-400 italic">None</span>'}
                                </div>
                            </div>
                            <span class="text-sm font-mono text-gray-500">ID: ${group.id}</span>
                        </div>
                        
                        <div class="relative w-full h-2 rounded-full bg-gray-200 mb-4">
                            <div class="absolute inset-0 h-2 rounded-full ${progressBarColor}" style="width: ${progressBarWidth}%;"></div>
                        </div>

                        <p class="text-xl font-semibold text-gray-700">Points: ${group.pointsUsed} / ${group.pointLimit}</p>

                        <div class="mt-4 space-y-2">
                            <h4 class="text-lg font-medium text-gray-600 border-b pb-2">Units:</h4>
                            <ul id="unit-list-${group.id}"></ul>
                        </div>
                        
                        <!-- The Fallen Log -->
                        <div class="mt-8 pt-4 border-t border-gray-200">
                            <h4 class="text-lg font-medium text-red-600">The Fallen 💀</h4>
                            <ul id="fallen-list-${group.id}" class="mt-2 space-y-1"></ul>
                        </div>
                    `;

                    rostersContainer.appendChild(groupCard);

                    const unitList = groupCard.querySelector(`#unit-list-${group.id}`);
                    if (group.units.length === 0) {
                        unitList.innerHTML = '<li class="text-gray-400 italic text-sm">No units in this group.</li>';
                    } else {
                        group.units.forEach((unit, index) => {
                            const unitItem = document.createElement('li');
                            unitItem.className = 'flex items-center justify-between text-gray-700 text-sm py-1 border-b border-gray-100 last:border-b-0';
                            unitItem.innerHTML = `
                                <span>${unit.name} <span class="text-xs text-gray-500">(${unit.cost} pts)</span></span>
                                <div class="flex items-center space-x-2">
                                    <!-- Tombstone button for "The Fallen" -->
                                    <button class="action-btn text-gray-400 hover:text-red-500 transition-colors" data-action="fall" data-group-id="${group.id}" data-unit-index="${index}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 384 512" fill="currentColor">
                                            <path d="M192 0C86 0 0 86 0 192V448C0 465.7 14.33 480 32 480H64V512H96V480H288V512H320V480H352C369.7 480 384 465.7 384 448V192C384 86 298 0 192 0zM224 256C224 264.8 216.8 272 208 272H176C167.2 272 160 264.8 160 256V224C160 215.2 167.2 208 176 208H208C216.8 208 224 215.2 224 224V256zM224 352C224 360.8 216.8 368 208 368H176C167.2 368 160 360.8 160 352V320C160 311.2 167.2 304 176 304H208C216.8 304 224 311.2 224 320V352z"/>
                                        </svg>
                                    </button>
                                    <!-- Trashcan button for permanent deletion -->
                                    <button class="action-btn text-gray-400 hover:text-red-700 transition-colors" data-action="delete" data-group-id="${group.id}" data-unit-index="${index}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            `;
                            unitList.appendChild(unitItem);
                        });
                    }

                    const fallenList = groupCard.querySelector(`#fallen-list-${group.id}`);
                    if (group.fallenUnits.length === 0) {
                        fallenList.innerHTML = '<li class="text-gray-400 italic text-sm">None have fallen yet.</li>';
                    } else {
                        group.fallenUnits.forEach(unit => {
                            const fallenItem = document.createElement('li');
                            fallenItem.className = 'flex items-center justify-between text-red-400 text-sm py-1 border-b border-gray-100 last:border-b-0';
                            fallenItem.textContent = `${unit.name} (${unit.cost} pts)`;
                            fallenList.appendChild(fallenItem);
                        });
                    }

                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = `${group.name} (ID: ${group.id})`;
                    groupSelect.appendChild(option);
                });

                if (selectedGroupId && groups.some(g => g.id === parseInt(selectedGroupId))) {
                    groupSelect.value = selectedGroupId;
                }
                if (selectedFaction) {
                    factionSelect.value = selectedFaction;
                    if (selectedFaction === "Adeptus Astartes") {
                        chapterSelectContainer.classList.remove('hidden');
                        populateChapterSelect();
                        if (selectedChapter) {
                            chapterSelect.value = selectedChapter;
                        }
                    } else {
                        chapterSelectContainer.classList.add('hidden');
                    }
                    populateUnitSelect(selectedFaction, selectedChapter);
                }

                document.querySelectorAll('.action-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const groupId = e.currentTarget.getAttribute('data-group-id');
                        const unitIndex = e.currentTarget.getAttribute('data-unit-index');
                        const action = e.currentTarget.getAttribute('data-action');
                        
                        if (action === 'delete') {
                            deleteUnit(groupId, unitIndex);
                        } else if (action === 'fall') {
                            moveUnitToFallen(groupId, unitInde
