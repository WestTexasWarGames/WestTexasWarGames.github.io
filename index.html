<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Deck</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Login Page -->
    <div id="login-page" class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-8 space-y-8 text-center">
        <h1 class="text-4xl font-bold text-gray-800">Welcome to Command Deck</h1>
        <p class="mt-2 text-lg text-gray-600">Sign in to access your personal roster.</p>
        
        <form id="auth-form" class="space-y-4">
            <input type="email" id="email-input" placeholder="Email" required class="w-full p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="password-input" placeholder="Password" required class="w-full p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <button type="button" id="register-btn" class="flex-grow px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                    Register
                </button>
                <button type="button" id="sign-in-btn" class="flex-grow px-4 py-2 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition-colors shadow-lg">
                    Sign In
                </button>
            </div>
        </form>
        <p id="auth-message" class="text-sm text-red-500 mt-4"></p>
    </div>

    <!-- Command Deck Page (Initially Hidden) -->
    <div id="roster-app-page" class="hidden bg-white rounded-2xl shadow-xl w-full max-w-4xl p-8 space-y-8">
        <header class="text-center">
            <h1 id="command-deck-title" class="text-4xl font-bold text-gray-800">Command Deck</h1>
            <p class="mt-2 text-lg text-gray-600">Organize your groups and units.</p>
        </header>
        
        <div class="flex justify-between items-center">
            <div class="text-sm text-gray-600">Your User ID: <span id="user-id" class="font-mono text-gray-800"></span></div>
            <button id="sign-out-btn" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-xl shadow-lg hover:bg-gray-600 transition-colors">
                Sign Out
            </button>
        </div>

        <!-- Control Buttons -->
        <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="add-battleship" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                Add Battleship
            </button>
            <button id="add-heavy-cruiser" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                Add Heavy Cruiser
            </button>
            <button id="add-cruiser" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                Add Cruiser
            </button>
        </div>
        
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Unit Assignment</h2>
            <form id="add-unit-form" class="space-y-4">
                <div>
                    <label for="group-select" class="block text-sm font-medium text-gray-700">Muster Point</label>
                    <select id="group-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div>
                    <label for="unit-name-input" class="block text-sm font-medium text-gray-700">Unit Name</label>
                    <input type="text" id="unit-name-input" placeholder="Enter unit name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                </div>
                <div>
                    <label for="unit-cost-input" class="block text-sm font-medium text-gray-700">Unit Cost</label>
                    <input type="number" id="unit-cost-input" placeholder="Enter unit cost" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                </div>
                <button type="submit" class="w-full px-4 py-2 bg-emerald-600 text-white font-semibold rounded-xl hover:bg-emerald-700 transition-colors shadow-lg">
                    Add Unit
                </button>
            </form>
        </div>

        <!-- Roster Display Area -->
        <div id="rosters-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Roster cards will be populated by JavaScript -->
        </div>

        <!-- Message Box for Alerts -->
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
                <p id="message-text" class="text-gray-800 text-lg font-medium"></p>
                <button id="close-message" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors">OK</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Your Firebase project configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCt_hsh6MCo_0sNWFKtAlsM-oSGVRGDPF8",
            authDomain: "conquest-command-deck.firebaseapp.com",
            projectId: "conquest-command-deck",
            storageBucket: "conquest-command-deck.firebasestorage.app",
            messagingSenderId: "993959061285",
            appId: "1:993959061285:web:438296814ad21edc0b1ccc",
            measurementId: "G-87NN5SXHXB"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DOM Element References ---
        const loginPage = document.getElementById('login-page');
        const rosterAppPage = document.getElementById('roster-app-page');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const registerBtn = document.getElementById('register-btn');
        const signInBtn = document.getElementById('sign-in-btn');
        const authMessage = document.getElementById('auth-message');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userIdSpan = document.getElementById('user-id');
        
        const addBattleshipBtn = document.getElementById('add-battleship');
        const addHeavyCruiserBtn = document.getElementById('add-heavy-cruiser');
        const addCruiserBtn = document.getElementById('add-cruiser');
        const addBluePlanetBtn = document.getElementById('add-blue-planet');
        const addRedPlanetBtn = document.getElementById('add-red-planet');
        const addGoldPlanetBtn = document.getElementById('add-gold-planet');
        const rostersContainer = document.getElementById('rosters-container');
        const addUnitForm = document.getElementById('add-unit-form');
        const groupSelect = document.getElementById('group-select');
        const unitNameInput = document.getElementById('unit-name-input');
        const unitCostInput = document.getElementById('unit-cost-input');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageBtn = document.getElementById('close-message');
        
        // --- Core Data Model ---
        let groups = [];
        let nextGroupId = 0;
        let currentPlayerId = null;

        // --- Core Application Logic ---
        function showMessage(message) {
            authMessage.textContent = message;
        }

        function clearMessage() {
            messageText.textContent = '';
            messageBox.classList.add('hidden');
        }

        async function saveGroups(playerId) {
            if (!playerId) return;
            const playerDocRef = doc(db, `rosters`, playerId);
            try {
                await setDoc(playerDocRef, { groups: groups });
            } catch (error) {
                console.error("Error saving groups:", error);
                showMessage("Failed to save roster. Please check your connection.");
            }
        }

        function loadGroups(playerId) {
            if (!playerId) return;
            const playerDocRef = doc(db, `rosters`, playerId);
            onSnapshot(playerDocRef, (doc) => {
                if (doc.exists()) {
                    groups = doc.data().groups;
                } else {
                    groups = [];
                }
                nextGroupId = groups.length > 0 ? Math.max(...groups.map(g => g.id)) + 1 : 0;
                renderUI();
            }, (error) => {
                console.error("Error listening to group changes:", error);
            });
        }
        
        function addGroup(name, pointLimit) {
            const newGroup = {
                id: nextGroupId++,
                name: name,
                pointLimit: pointLimit,
                pointsUsed: 0,
                units: [],
                fallenUnits: [],
            };
            groups.push(newGroup);
            saveGroups(currentPlayerId);
            renderUI();
        }

        function editGroupName(groupId, newName) {
            const group = groups.find(g => g.id === parseInt(groupId));
            if (group) {
                group.name = newName;
                saveGroups(currentPlayerId);
                renderUI();
            }
        }

        function addUnit(groupId, unitName, unitCost) {
            const group = groups.find(g => g.id === parseInt(groupId));
            if (!group) {
                showMessage("Error: Group not found.");
                return;
            }

            if (group.pointsUsed + unitCost > group.pointLimit) {
                showMessage(`Cannot add unit. Adding ${unitCost} points would exceed the group's limit of ${group.pointLimit}.`);
                return;
            }

            const newUnit = {
                name: unitName,
                cost: unitCost
            };
            group.units.push(newUnit);
            group.pointsUsed += unitCost;
            
            saveGroups(currentPlayerId);
            renderUI();
        }

        function deleteUnit(groupId, unitIndex) {
            const group = groups.find(g => g.id === parseInt(groupId));
            if (!group || !group.units[unitIndex]) {
                showMessage("Error: Unit or group not found.");
                return;
            }

            const unitCost = group.units[unitIndex].cost;
            group.units.splice(unitIndex, 1);
            group.pointsUsed -= unitCost;
            saveGroups(currentPlayerId);
            renderUI();
        }

        function moveUnitToFallen(groupId, unitIndex) {
            const group = groups.find(g => g.id === parseInt(groupId));
            if (!group || !group.units[unitIndex]) {
                showMessage("Error: Unit or group not found.");
                return;
            }

            const fallenUnit = group.units.splice(unitIndex, 1)[0];
            group.fallenUnits.push(fallenUnit);
            group.pointsUsed -= fallenUnit.cost;
            saveGroups(currentPlayerId);
            renderUI();
        }

        function deleteFallenUnit(groupId, unitIndex) {
            const group = groups.find(g => g.id === parseInt(groupId));
            if (!group || !group.fallenUnits[unitIndex]) {
                showMessage("Error: Fallen unit or group not found.");
                return;
            }
            group.fallenUnits.splice(unitIndex, 1);
            saveGroups(currentPlayerId);
            renderUI();
        }

        function deleteGroup(groupId) {
            const groupIndex = groups.findIndex(g => g.id === parseInt(groupId));
            if (groupIndex !== -1) {
                groups.splice(groupIndex, 1);
                saveGroups(currentPlayerId);
                renderUI();
            }
        }
        
        function renderUI() {
            const selectedGroupId = groupSelect.value;
            
            rostersContainer.innerHTML = '';
            groupSelect.innerHTML = '<option value="" disabled selected>Select Ship\\Planet...</option>';

            if (groups.length === 0) {
                rostersContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">Click a button above to add a group.</p>';
            }

            groups.forEach(group => {
                const groupCard = document.createElement('div');
                groupCard.className = 'bg-gray-50 rounded-xl shadow-md p-6 border border-gray-200 relative overflow-hidden';

                const percentage = (group.pointsUsed / group.pointLimit) * 100;
                const progressBarColor = percentage > 100 ? 'bg-red-500' : 'bg-green-500';
                const progressBarWidth = Math.min(percentage, 100);
                
                groupCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 inline-block align-middle" data-group-id="${group.id}">${group.name}</h3>
                            <button class="edit-name-btn ml-2 text-gray-400 hover:text-gray-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block align-middle" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                        </div>
                        <span class="text-sm font-mono text-gray-500">ID: ${group.id}</span>
                    </div>
                    
                    <div class="relative w-full h-2 rounded-full bg-gray-200 mb-4">
                        <div class="absolute inset-0 h-2 rounded-full ${progressBarColor}" style="width: ${progressBarWidth}%;"></div>
                    </div>

                    <p class="text-xl font-semibold text-gray-700">Points: ${group.pointsUsed} / ${group.pointLimit}</p>

                    <div class="mt-4 space-y-2">
                        <h4 class="text-lg font-medium text-gray-600 border-b pb-2">Units:</h4>
                        <ul id="unit-list-${group.id}"></ul>
                    </div>
                    
                    <!-- The Fallen Log -->
                    <div class="mt-8 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-medium text-red-600">The Fallen 💀</h4>
                        <ul id="fallen-list-${group.id}" class="mt-2 space-y-1"></ul>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button class="delete-group-btn px-4 py-2 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition-colors shadow-lg" data-group-id="${group.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block align-middle" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;

                rostersContainer.appendChild(groupCard);

                const unitList = groupCard.querySelector(`#unit-list-${group.id}`);
                if (group.units.length === 0) {
                    unitList.innerHTML = '<li class="text-gray-400 italic text-sm">No units in this group.</li>';
                } else {
                    group.units.forEach((unit, index) => {
                        const unitItem = document.createElement('li');
                        unitItem.className = 'flex items-center justify-between text-gray-700 text-sm py-1 border-b border-gray-100 last:border-b-0';
                        unitItem.innerHTML = `
                            <span>${unit.name} <span class="text-xs text-gray-500">(${unit.cost} pts)</span></span>
                            <div class="flex items-center space-x-2">
                                <!-- Tombstone button for "The Fallen" -->
                                <button class="action-btn text-gray-400 hover:text-red-500 transition-colors" data-action="fall" data-group-id="${group.id}" data-unit-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M192 0C86 0 0 86 0 192V448C0 465.7 14.33 480 32 480H64V512H96V480H288V512H320V480H352C369.7 480 384 465.7 384 448V192C384 86 298 0 192 0zM224 256C224 264.8 216.8 272 208 272H176C167.2 272 160 264.8 160 256V224C160 215.2 167.2 208 176 208H208C216.8 208 224 215.2 224 224V256zM224 352C224 360.8 216.8 368 208 368H176C167.2 368 160 360.8 160 352V320C160 311.2 167.2 304 176 304H208C216.8 304 224 311.2 224 320V352z"/>
                                    </svg>
                                </button>
                                <!-- Trashcan button for permanent deletion -->
                                <button class="action-btn text-gray-400 hover:text-red-700 transition-colors" data-action="delete" data-group-id="${group.id}" data-unit-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        `;
                        unitList.appendChild(unitItem);
                    });
                }

                const fallenList = groupCard.querySelector(`#fallen-list-${group.id}`);
                if (group.fallenUnits.length === 0) {
                    fallenList.innerHTML = '<li class="text-gray-400 italic text-sm">None have fallen yet.</li>';
                } else {
                    group.fallenUnits.forEach((unit, index) => { // Added index here
                        const fallenItem = document.createElement('li');
                        fallenItem.className = 'flex items-center justify-between text-red-400 text-sm py-1 border-b border-gray-100 last:border-b-0';
                        fallenItem.innerHTML = `
                            <span>${unit.name} (${unit.cost} pts)</span>
                            <button class="delete-fallen-btn text-gray-400 hover:text-red-700 transition-colors" data-group-id="${group.id}" data-unit-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        `;
                        fallenList.appendChild(fallenItem);
                    });
                }

                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = `${group.name} (ID: ${group.id})`;
                groupSelect.appendChild(option);
            });

            if (selectedGroupId && groups.some(g => g.id === parseInt(selectedGroupId))) {
                groupSelect.value = selectedGroupId;
            }
        }

        function setupEventListeners() {
            registerBtn.addEventListener('click', () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                if (!email || !password) {
                    showMessage("Please enter an email and password.");
                    return;
                }
                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        showMessage("Registration successful! You are now signed in.");
                    })
                    .catch((error) => {
                        showMessage(error.message);
                    });
            });

            signInBtn.addEventListener('click', () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                if (!email || !password) {
                    showMessage("Please enter an email and password.");
                    return;
                }
                signInWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        showMessage("Sign in successful!");
                    })
                    .catch((error) => {
                        showMessage(error.message);
                    });
            });

            signOutBtn.addEventListener('click', () => {
                signOut(auth)
                    .then(() => {
                        groups = [];
                        currentPlayerId = null;
                        renderUI();
                    })
                    .catch((error) => {
                        showMessage(`Logout failed: ${error.message}`);
                    });
            });

            addBattleshipBtn.addEventListener('click', () => {
                addGroup('Battleship', 1500);
            });

            addHeavyCruiserBtn.addEventListener('click', () => {
                addGroup('Heavy Cruiser', 1000);
            });

            addCruiserBtn.addEventListener('click', () => {
                addGroup('Cruiser', 500);
            });
            
            addUnitForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const selectedGroupId = groupSelect.value;
                const unitName = unitNameInput.value;
                const unitCost = parseInt(unitCostInput.value, 10);
                
                if (!selectedGroupId) {
                    showMessage("Please select a muster point first.");
                    return;
                }
                if (!unitName || isNaN(unitCost)) {
                    showMessage("Please enter a valid unit name and cost.");
                    return;
                }
                
                const group = groups.find(g => g.id === parseInt(selectedGroupId));
                if (group.pointsUsed + unitCost > group.pointLimit) {
                    showMessage(`Cannot add unit. Adding ${unitCost} points would exceed the group's limit of ${group.pointLimit}.`);
                    return;
                }
                
                addUnit(selectedGroupId, unitName, unitCost);

                unitNameInput.value = "";
                unitCostInput.value = "";
            });
            
            rostersContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const groupId = button.getAttribute('data-group-id');
                const unitIndex = button.getAttribute('data-unit-index');
                const action = button.getAttribute('data-action');

                if (action === 'delete') {
                    deleteUnit(groupId, unitIndex);
                } else if (action === 'fall') {
                    moveUnitToFallen(groupId, unitIndex);
                } else if (button.classList.contains('delete-group-btn')) {
                    deleteGroup(groupId);
                } else if (button.classList.contains('edit-name-btn')) {
                    const groupNameElement = button.previousElementSibling;
                    const currentName = groupNameElement.textContent;
                    
                    const inputField = document.createElement('input');
                    inputField.type = 'text';
                    inputField.value = currentName;
                    inputField.className = 'text-2xl font-bold text-gray-800 bg-gray-100 rounded-md p-1 focus:outline-none focus:ring-2 focus:ring-indigo-500';

                    const saveButton = document.createElement('button');
                    saveButton.textContent = 'Save';
                    saveButton.className = 'ml-2 px-3 py-1 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600';

                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancel';
                    cancelButton.className = 'ml-2 px-3 py-1 bg-gray-300 text-gray-800 rounded-xl hover:bg-gray-400';

                    const parentDiv = groupNameElement.parentNode;
                    parentDiv.replaceChild(inputField, groupNameElement);
                    parentDiv.replaceChild(saveButton, button);
                    parentDiv.appendChild(cancelButton);

                    inputField.focus();

                    saveButton.addEventListener('click', () => {
                        editGroupName(groupId, inputField.value);
                    });
                    
                    cancelButton.addEventListener('click', () => {
                        renderUI();
                    });
                }
            });
            
            closeMessageBtn.addEventListener('click', () => {
                messageBox.classList.add('hidden');
            });
        }

        // Call the setup function on window load
        window.onload = setupEventListeners;

    </script>
</body>
</html>
